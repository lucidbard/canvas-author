# End-to-End Tests against real Canvas LMS instance
#
# This workflow runs E2E tests that interact with a real Canvas installation.
# It is triggered manually or by adding the 'run-e2e' label to a PR.
#
# Required secrets:
#   E2E_CANVAS_API_TOKEN - Canvas API token for test user
#   E2E_CANVAS_DOMAIN    - Canvas domain (e.g., canvas.instructure.com)
#   E2E_CANVAS_COURSE_ID - Dedicated test course ID
#
# Optional secrets:
#   E2E_CANVAS_ASSIGNMENT_WITH_RUBRIC - Assignment ID with rubric for rubric tests
#   E2E_CANVAS_DISCUSSION_ID          - Discussion topic ID for discussion tests

name: E2E Tests

on:
  # Manual trigger - primary method
  workflow_dispatch:

  # Run on PR with specific label
  pull_request:
    types: [labeled]

jobs:
  e2e-tests:
    # Only run if manually triggered or if PR has 'run-e2e' label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-e2e'))

    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Install dependencies
        run: |
          pip install -e .
          pip install -e ".[dev]"

      - name: Verify pandoc installation
        run: pandoc --version

      - name: Run E2E tests
        env:
          E2E_CANVAS_API_TOKEN: ${{ secrets.E2E_CANVAS_API_TOKEN }}
          E2E_CANVAS_DOMAIN: ${{ secrets.E2E_CANVAS_DOMAIN }}
          E2E_CANVAS_COURSE_ID: ${{ secrets.E2E_CANVAS_COURSE_ID }}
          E2E_CANVAS_ASSIGNMENT_WITH_RUBRIC: ${{ secrets.E2E_CANVAS_ASSIGNMENT_WITH_RUBRIC }}
          E2E_CANVAS_DISCUSSION_ID: ${{ secrets.E2E_CANVAS_DISCUSSION_ID }}
          E2E_CANVAS_SKIP_CLEANUP: "false"
        run: |
          pytest tests/e2e/ -v -m e2e --tb=short --maxfail=5

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            .pytest_cache/
            htmlcov/
          retention-days: 7

      - name: Comment on PR with results
        if: |
          always() &&
          github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const body = `## E2E Test Results\n\n**Status:** ${status}\n\n` +
              `View detailed results in the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
